{% extends "base.html" %}
{% block title %}{{ topic|title }} ‚Ä¢ Quiz{% endblock %}

{% block content %}
<div class="container">
  <div class="flex items-center justify-between mb-4" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <h2 class="m-0" style="margin:0">{{ topic|title }} Quiz</h2>

    <div style="display:flex;gap:8px;align-items:center;">
      <a class="btn" href="{{ url_for('quiz.quiz_menu') }}" aria-label="Back to topics">‚Üê Back</a>
      <button id="regenBtn" class="btn primary">üîÅ Regenerate</button>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress mb-3" style="width:100%;height:14px;border:1px solid var(--ring);border-radius:10px;overflow:hidden;background:#f3f4f6;">
    <div id="masteryBar" style="height:100%;width:0%;background:var(--brand);color:#fff;text-align:center;font-size:12px;line-height:14px;">0%</div>
  </div>

  <!-- Quiz card -->
  <div id="quiz-card" class="note-fig" style="padding:16px;">
    <div id="question-box"></div>
    <div id="feedback" class="mt-3" style="margin-top:12px;"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="nextBtn" class="btn" style="display:none;">Next</button>
    </div>
  </div>

  <!-- Empty state -->
  <div id="empty-state" class="note-fig" style="padding:16px;display:none;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div>‚ö†Ô∏è No quiz questions found for this topic.</div>
      <button id="genBtn" class="btn primary">‚ú® Generate Quiz</button>
    </div>
    <small style="display:block;color:var(--muted);margin-top:8px;">We‚Äôll create 5 multiple-choice questions from your notes titled ‚Äú{{ topic }}‚Äù.</small>
  </div>

  <!-- Result -->
  <div id="result-box" class="note-fig" style="padding:16px;display:none;">
    <h3 style="margin-top:0;">üéâ You finished!</h3>
    <p>Mastery: <strong><span id="masteryScore">0</span>%</strong></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button onclick="location.reload()" class="btn primary">Retry</button>
      <button id="regenBtnBottom" class="btn">Regenerate</button>
      <a class="btn" href="{{ url_for('quiz.quiz_menu') }}">Back to topics</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Data from server
  const TOPIC = {{ topic|tojson }};
  const QUESTIONS = {{ questions|tojson }};

  // Elements
  const quizCard    = document.getElementById('quiz-card');
  const emptyState  = document.getElementById('empty-state');
  const resultBox   = document.getElementById('result-box');
  const qBox        = document.getElementById('question-box');
  const feedback    = document.getElementById('feedback');
  const nextBtn     = document.getElementById('nextBtn');
  const masteryBar  = document.getElementById('masteryBar');
  const regenBtn    = document.getElementById('regenBtn');
  const regenBtnBottom = document.getElementById('regenBtnBottom');
  const genBtn      = document.getElementById('genBtn');

  // State
  let current = 0;
  let score   = 0;

  // Utilities
  const correctIndex = (q) => (typeof q.answer_index === 'number') ? q.answer_index : q.answer;

  function setMastery() {
    const pct = QUESTIONS.length ? Math.round((score / QUESTIONS.length) * 100) : 0;
    masteryBar.style.width = pct + '%';
    masteryBar.textContent = pct + '%';
    return pct;
  }

  function renderQuestion() {
    const q = QUESTIONS[current];
    feedback.innerHTML = '';
    nextBtn.style.display = 'none';

    // Buttons list
    const optionsHTML = q.options.map((opt, i) => {
      return `<button type="button" class="btn" style="display:block;width:100%;text-align:left;margin-top:8px;"
                data-index="${i}" onclick="checkAnswer(${i})">${String.fromCharCode(65+i)}. ${opt}</button>`;
    }).join('');

    qBox.innerHTML = `
      <div style="margin-bottom:6px;color:var(--muted);font-size:14px;">Question ${current + 1} of ${QUESTIONS.length}</div>
      <h3 style="margin:4px 0 10px;">${q.question}</h3>
      <div id="options">${optionsHTML}</div>
    `;
  }

  window.checkAnswer = function(selected) {
    const q = QUESTIONS[current];
    const correct = correctIndex(q);

    const optionBtns = Array.from(document.querySelectorAll('#options .btn'));
    optionBtns.forEach((btn, i) => {
      btn.disabled = true;
      if (i === correct) {
        btn.style.borderColor = '#22c55e';
        btn.style.background = '#ecfdf5';
      }
      if (i === selected && selected !== correct) {
        btn.style.borderColor = '#ef4444';
        btn.style.background = '#fef2f2';
      }
    });

    if (selected === correct) {
      score++;
      feedback.innerHTML = `<div>‚úÖ Correct!</div>${q.explanation ? `<div style="color:var(--muted);margin-top:6px;">${q.explanation}</div>` : ''}`;
    } else {
      // no negative mark; simple mastery
      feedback.innerHTML = `<div>‚ùå Incorrect.</div>${q.explanation ? `<div style="color:var(--muted);margin-top:6px;">${q.explanation}</div>` : ''}`;
    }

    setMastery();
    nextBtn.style.display = 'inline-block';
  };

  nextBtn.addEventListener('click', () => {
    current++;
    if (current < QUESTIONS.length) {
      renderQuestion();
    } else {
      quizCard.style.display = 'none';
      resultBox.style.display = 'block';
      document.getElementById('masteryScore').textContent = setMastery();
    }
  });

  async function generateQuiz(btn) {
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Generating‚Ä¶';
    try {
      const res = await fetch('{{ url_for("quiz.generate_quiz") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ topic: TOPIC })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to generate quiz');
      location.reload();
    } catch (e) {
      alert(e.message);
      btn.disabled = false;
      btn.textContent = original;
    }
  }

  // Wire buttons
  if (regenBtn)       regenBtn.addEventListener('click', () => generateQuiz(regenBtn));
  if (regenBtnBottom) regenBtnBottom.addEventListener('click', () => generateQuiz(regenBtnBottom));
  if (genBtn)         genBtn.addEventListener('click', () => generateQuiz(genBtn));

  // Init
  if (!Array.isArray(QUESTIONS) || QUESTIONS.length === 0) {
    quizCard.style.display = 'none';
    emptyState.style.display = 'block';
  } else {
    renderQuestion();
    setMastery();
  }
</script>
{% endblock %}

